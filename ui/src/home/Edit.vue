<template>
  <el-dialog v-model="downloadPathDialogVisible" v-if="downloadPathDialogVisible" center align-center width="300">
    <div>
      <el-text class="mx-1" size="default">
        检测到修改后的下载位置发生了改动，是否将已下载文件移动到新的位置？
        <br>
        <br>
        新的位置: {{ downloadPath }}
      </el-text>
    </div>
    <div style="width:100%;display: flex;justify-content: end;margin-top: 8px;">
      <el-button icon="Check" text bg type="danger" @click="()=>{
        move = true
        editAni()
        downloadPathDialogVisible = false
      }">移动
      </el-button>
      <el-button icon="Close" bg text @click="()=>{
        move = false
        editAni()
        downloadPathDialogVisible = false
      }">不移动
      </el-button>
    </div>
  </el-dialog>
  <el-dialog v-model="dialogVisible" title="修改订阅" center v-if="dialogVisible">
    <Ani v-model:ani="ani" @ok="editChange"/>
  </el-dialog>
</template>

<script setup>

import {ref} from "vue";
import {ElMessage} from "element-plus";
import api from "../api.js";
import Ani from "./Ani.vue";


const dialogVisible = ref(false)
const downloadPathDialogVisible = ref(false)

const ani = ref({
  'url': '',
  'season': 1,
  'offset': 0,
  'title': '',
  'themoviedbName': '',
  'exclude': [],
  'enable': true,
  'ova': false,
  'totalEpisodeNumber': '',
  'customDownloadPath': false,
  'downloadPath': ''
})

let move = ref(false)
let downloadPath = ref('')
let callback = ref(() => {
})

const editChange = async (fun) => {
  callback.value = fun
  let req = await api.post('api/downloadPath', ani.value)
  downloadPath.value = req.data.downloadPath
  if (req.data.change) {
    downloadPathDialogVisible.value = true
    return
  }
  editAni()
}

const editAni = () => {
  api.put('api/ani?move=' + move.value, ani.value)
      .then(res => {
        ElMessage.success(res.message)
        emit('load')
        dialogVisible.value = false
      })
      .finally(callback);
}

const show = (item) => {
  ani.value = JSON.parse(JSON.stringify(item))
  ani.value.showDownlaod = true
  move.value = false
  dialogVisible.value = true
}

defineExpose({
  show
})

const emit = defineEmits(['load'])
</script>
